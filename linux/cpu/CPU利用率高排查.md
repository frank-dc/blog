# CPU利用率高排查
- [CPU利用率高排查](#cpu利用率高排查)
  - [一、理解 CPU 利用率的构成](#一理解-cpu-利用率的构成)
  - [二、排查思路框架](#二排查思路框架)
  - [三、详细排查步骤](#三详细排查步骤)
    - [1. 定位高 CPU 占用的进程](#1-定位高-cpu-占用的进程)
    - [2. 查看进程内部线程 CPU 占用](#2-查看进程内部线程-cpu-占用)
    - [3. 查看系统态 CPU 占比高时的原因](#3-查看系统态-cpu-占比高时的原因)
      - [情形一：系统调用频繁](#情形一系统调用频繁)
      - [情形二：内核函数热点（perf 分析）](#情形二内核函数热点perf-分析)
      - [情形三：软中断/硬中断异常高](#情形三软中断硬中断异常高)
    - [4. 上下文切换过多](#4-上下文切换过多)
    - [5. CPU 饱和 vs 并发低效](#5-cpu-饱和-vs-并发低效)
      - [Java 检查 GC:](#java-检查-gc)
    - [6. 容器或虚拟化场景特殊检查](#6-容器或虚拟化场景特殊检查)
  - [四、使用工具推荐](#四使用工具推荐)
  - [五、排查案例示例（实战）](#五排查案例示例实战)
    - [案例一：某 Java 服务 CPU 忽然飙升至 800%](#案例一某-java-服务-cpu-忽然飙升至-800)
  - [六、总结](#六总结)

## 一、理解 CPU 利用率的构成

可以通过 `top` 或 `mpstat` 查看：

```
%us 用户态
%sy 内核态（系统态）
%ni 用户进程优先级变更
%id 空闲
%wa IO等待
%hi 硬中断
%si 软中断
%st 虚拟机偷取
```

------

## 二、排查思路框架

| 排查维度   | 关键指标         | 工具                                          | 目标                               |
| ---------- | ---------------- | --------------------------------------------- | ---------------------------------- |
| 进程层面   | 高CPU进程        | `top`, `htop`, `pidstat`                      | 找到“罪魁祸首”                     |
| 线程层面   | 单核满负载       | `top -H`, `ps -Lp`                            | 是否是单线程高负载                 |
| 系统调用   | `strace`、`perf` | 分析热点函数或系统调用                        |                                    |
| 应用语言层 | Java/Python/Go   | 如 `jstack`、`py-spy`、`pprof`                | 分析应用内部原因                   |
| 中断层     | 中断软中断       | `vmstat`, `mpstat -I`, `cat /proc/interrupts` | 判断系统是否频繁处理中断           |
| 内核层     | 调度/锁          | `perf`, `bpftrace`, `systemtap`               | 是否因内核调度、锁争用导致系统态高 |



------

## 三、详细排查步骤

### 1. 定位高 CPU 占用的进程

```
top -o %CPU
```

查看是否是：

- 某个应用服务单独占用
- 多进程并发消耗
- 系统进程（如 `ksoftirqd`、`kworker`）占用

### 2. 查看进程内部线程 CPU 占用

```
top -Hp <pid>
```

找出消耗高的线程，再通过：

```
printf "%x\n" <tid>   # 转为十六进制
```

结合语言运行时：

- **Java:** `jstack <pid> | grep -A30 <hex-tid>`
- **Python:** `py-spy top -p <pid>`
- **Go:** `go tool pprof` + HTTP Profile

------

### 3. 查看系统态 CPU 占比高时的原因

#### 情形一：系统调用频繁

```
strace -p <pid> -c    # 汇总系统调用
```

#### 情形二：内核函数热点（perf 分析）

```
perf top -p <pid>
perf record -p <pid> && perf report
```

- 判断是否因频繁调度、内核锁、page fault 等原因导致。

#### 情形三：软中断/硬中断异常高

```
cat /proc/interrupts
```

如果 `eth0`、`eth1` 中断很高，可能是网络包处理导致 CPU 高。

```
mpstat -P ALL -I SUM 1
```

查看软中断（soft）是否异常高。

**排查方向：**

- 关闭网卡中断绑定 balance，绑定特定 CPU
- 使用 `irqbalance` 工具优化中断调度
- 配置 RPS/XPS 优化网卡数据包处理

------

### 4. 上下文切换过多

```
vmstat 1
```

如果 `cs`（上下文切换次数）非常高：

- 线程过多或频繁抢占 CPU（如锁竞争严重）
- 某些用户态程序频繁 sleep/wakeup（典型如 epoll + 小事件）

------

### 5. CPU 饱和 vs 并发低效

如果：

- CPU 使用率高
- 但业务 TPS 并不高

则怀疑：

- 死循环、逻辑错误（如递归未退出）
- 内部大量无效轮询（如 `while(true) sleep 0`）
- 锁等待和竞争（并发程序常见）
- GC 或垃圾回收异常（Java）

#### Java 检查 GC:

```
jstat -gcutil <pid> 1000 5
```

------

### 6. 容器或虚拟化场景特殊检查

- 容器内 CPU 限制：查看 cgroups 限制
- 虚拟机偷取（steal）高：说明宿主机 CPU 资源竞争严重

```
top   # %st 比例大
```

------

## 四、使用工具推荐

| 工具                                | 说明                                   |
| ----------------------------------- | -------------------------------------- |
| `top` / `htop`                      | 实时查看系统整体与进程占用             |
| `pidstat -u -p ALL 1`               | 每个进程 CPU 使用率                    |
| `perf top / record`                 | 分析函数级别 CPU 使用                  |
| `bpftrace`, `bcc`                   | 深度内核分析，如调度器、锁、syscall 等 |
| `py-spy`, `jstack`, `go tool pprof` | 应用语言层分析                         |
| `vmstat`, `mpstat`, `sar`           | 综合监控视角                           |
| `systemtap`                         | 动态追踪内核行为                       |



------

## 五、排查案例示例（实战）

### 案例一：某 Java 服务 CPU 忽然飙升至 800%

- `top` 查出进程 PID
- `top -Hp <pid>` 查看是哪个线程
- `jstack` 查看线程栈：发现是 `ConcurrentHashMap.get()` 的死锁卡住，锁竞争严重
- 代码优化并升级 JDK 后恢复

------

## 六、总结

| 维度        | 检查项                             |
| ----------- | ---------------------------------- |
| 系统维度    | CPU利用率构成、软中断、上下文切换  |
| 进程维度    | 哪些进程/线程使用最多              |
| 内核维度    | 系统态高？软中断？调度器负担？     |
| 应用维度    | 死循环？锁？垃圾回收？网络IO繁忙？ |
| 容器/虚拟化 | cgroup 限制、%steal                |

