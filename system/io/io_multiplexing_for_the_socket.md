# socket ç½‘ç»œæ¨¡åž‹çš„ I/O å¤šè·¯å¤ç”¨

## æ¦‚æ‹¬
æœ€åŸºç¡€çš„ TCP çš„ socket ç¼–ç¨‹ï¼Œå®ƒæ˜¯é˜»å¡ž I/O æ¨¡åž‹ï¼ŒåŸºæœ¬ä¸Šåªèƒ½ä¸€å¯¹ä¸€é€šä¿¡ï¼Œä¸ºäº†æœåŠ¡æ›´å¤šçš„å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬éœ€è¦æ”¹è¿›ç½‘ç»œ I/O æ¨¡åž‹ã€‚

æ¯”è¾ƒä¼ ç»Ÿçš„æ–¹å¼æ˜¯ä½¿ç”¨å¤šè¿›ç¨‹/çº¿ç¨‹æ¨¡åž‹ï¼Œæ¯æ¥ä¸€ä¸ªå®¢æˆ·ç«¯è¿žæŽ¥ï¼Œå°±åˆ†é…ä¸€ä¸ªè¿›ç¨‹/çº¿ç¨‹ï¼Œç„¶åŽåŽç»­çš„è¯»å†™éƒ½åœ¨å¯¹åº”çš„è¿›ç¨‹/çº¿ç¨‹å®Œæˆï¼Œè¿™ç§æ–¹å¼å¤„ç†ä¸€å®šæ•°é‡ï¼ˆæ¯”å¦‚100ä¸ªï¼‰çš„å®¢æˆ·ç«¯æ²¡é—®é¢˜ï¼Œä½†æ˜¯å½“å®¢æˆ·ç«¯å¢žåŠ åˆ°ä¸€ä¸‡ï¼Œç”šè‡³æ›´å¤šï¼Œé‚£ä¹ˆä¸€ä¸‡ä¸ªè¿›ç¨‹/çº¿ç¨‹çš„`è°ƒåº¦`ã€`ä¸Šä¸‹æ–‡åˆ‡æ¢`ä»¥åŠ`å ç”¨çš„å†…å­˜`éƒ½ä¼šæˆä¸ºç“¶é¢ˆã€‚

ä¸ºäº†è§£å†³ä¸Šé¢çš„ðŸ‘†ðŸ»é—®é¢˜ï¼Œå°±å‡ºçŽ°äº† I/O å¤šè·¯å¤ç”¨ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªè¿›ç¨‹/çº¿ç¨‹é‡Œå¤„ç†å¤šä¸ªæ–‡ä»¶çš„ I/Oï¼ˆç±»ä¼¼ä¸€ä¸ª CPU å¹¶å‘å¤šä¸ªè¿›ç¨‹ï¼‰, Linux æœ‰ä¸‰ç§æä¾› I/O å¤šè·¯å¤ç”¨çš„ APIï¼Œåˆ†åˆ«æ˜¯`select`ã€`poll`ã€`epoll`ã€‚

* select/poll

select å’Œ poll æ²¡æœ‰æœ¬è´¨åŒºåˆ«ï¼Œéƒ½æ˜¯ä½¿ç”¨`çº¿æ€§ç»“æž„`æ¥å­˜å‚¨è¿›ç¨‹å…³æ³¨çš„ socketï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰ é›†åˆã€‚

åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œé¦–å…ˆéœ€è¦æŠŠå…³æ³¨çš„ socket é›†åˆé€šè¿‡ select/poll ç³»ç»Ÿè°ƒç”¨ä»Žç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ï¼Œç”±å†…æ ¸æ€æ£€æµ‹äº‹ä»¶ï¼Œå½“æœ‰ç½‘ç»œäº‹ä»¶äº§ç”Ÿæ—¶ï¼Œå†…æ ¸éœ€è¦éåŽ†è¿›ç¨‹å…³æ³¨çš„ socket é›†åˆï¼Œæ‰¾åˆ°å¯¹åº”çš„ socketï¼Œå¹¶è®¾ç½®å…¶çŠ¶æ€å¯è¯»/å¯å†™ï¼Œç„¶åŽæŠŠæ•´ä¸ª socket é›†åˆä»Žå†…æ ¸æ€æ‹·è´åˆ°ç”¨æˆ·æ€ï¼Œç”¨æˆ·æ€è¿˜è¦ç»§ç»­éåŽ† socket é›†åˆæ‰¾åˆ°å¯è¯»/å¯å†™çš„ socketï¼Œç„¶åŽå¯¹å…¶å¤„ç†ã€‚

select å’Œ poll çš„ç¼ºé™·åœ¨äºŽï¼Œå½“å®¢æˆ·ç«¯è¶Šå¤šï¼Œä¹Ÿå°±æ˜¯ socket é›†åˆè¶Šå¤§ï¼Œå¯¹ socket é›†åˆçš„éåŽ†å’Œæ‹·è´ä¼šå¸¦æ¥å¾ˆå¤§çš„å¼€é”€ï¼Œå¾ˆéš¾åº”å¯¹C10k[^1]ã€‚

[^1]: ä¼˜åŒ–ç½‘ç»œå¥—æŽ¥å­—ä»¥åŒæ—¶å¤„ç†å¤§é‡å®¢æˆ·ç«¯çš„é—®é¢˜ã€‚

* epoll

epoll åœ¨å†…æ ¸é‡Œä½¿ç”¨`çº¢é»‘æ ‘`æ¥å…³æ³¨è¿›ç¨‹æ‰€æœ‰å¾…æ£€æµ‹çš„ socketï¼Œçº¢é»‘æ ‘æ˜¯ä¸ªé«˜æ•ˆçš„æ•°æ®ç»“æž„ï¼Œå¢žåˆ æŸ¥ä¸€èˆ¬æ—¶é—´å¤æ‚åº¦æ˜¯O(logn)ï¼Œé€šè¿‡å¯¹è¿™é¢—çº¢é»‘æ ‘çš„ç®¡ç†ï¼Œä¸éœ€è¦åƒ select/poll åœ¨æ¯æ¬¡æ“ä½œæ—¶éƒ½ä¼ å…¥æ•´ä¸ª socket é›†åˆï¼Œå‡å°‘äº†å†…æ ¸å’Œç”¨æˆ·ç©ºé—´å¤§é‡æ•°æ®çš„æ‹·è´å’Œå†…å­˜åˆ†é…ã€‚

epoll ä½¿ç”¨äº‹ä»¶é©±åŠ¨çš„æœºåˆ¶ï¼Œå†…æ ¸é‡Œç»´æŠ¤äº†ä¸€ä¸ª`é“¾è¡¨`æ¥è®°å½•å°±ç»ªäº‹ä»¶ï¼Œåªå°†æœ‰äº‹ä»¶å‘ç”Ÿçš„ socket é›†åˆä¼ é€’ç»™ç”¨æˆ·ç©ºé—´çš„åº”ç”¨ç¨‹åºï¼Œä¸éœ€è¦åƒ select/poll é‚£æ ·éåŽ†æ•´ä¸ª socket é›†åˆï¼ˆåŒ…å«æœ‰å’Œæ— äº‹ä»¶çš„socketï¼‰ï¼Œå¤§å¤§æé«˜äº†æ£€æµ‹æ•ˆçŽ‡ã€‚

epoll æ”¯æŒè¾¹ç¼˜è§¦å‘[^2]å’Œæ°´å¹³è§¦å‘[^3]ä¸¤ç§è§¦å‘çš„æ–¹å¼ï¼Œselect/poll åªæ”¯æŒæ°´å¹³è§¦å‘ã€‚

[^2]: å½“è¢«ç›‘æŽ§çš„ Socket æè¿°ç¬¦ä¸Šæœ‰å¯è¯»äº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒæœåŠ¡å™¨ç«¯åªä¼šä»Ž epoll_wait ä¸­è‹é†’ä¸€æ¬¡ï¼Œå³ä½¿è¿›ç¨‹æ²¡æœ‰è°ƒç”¨ read å‡½æ•°ä»Žå†…æ ¸è¯»å–æ•°æ®ï¼Œä¹Ÿä¾ç„¶åªè‹é†’ä¸€æ¬¡ï¼Œå› æ­¤æˆ‘ä»¬ç¨‹åºè¦ä¿è¯ä¸€æ¬¡æ€§å°†å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®è¯»å–å®Œã€‚

[^3]: å½“è¢«ç›‘æŽ§çš„ Socket ä¸Šæœ‰å¯è¯»äº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒæœåŠ¡å™¨ç«¯ä¸æ–­åœ°ä»Ž epoll_wait ä¸­è‹é†’ï¼Œç›´åˆ°å†…æ ¸ç¼“å†²åŒºæ•°æ®è¢« read å‡½æ•°è¯»å®Œæ‰ç»“æŸï¼Œç›®çš„æ˜¯å‘Šè¯‰æˆ‘ä»¬æœ‰æ•°æ®éœ€è¦è¯»å–ã€‚



## æ¥æº
> [https://bbs.huaweicloud.com/blogs/279731](https://bbs.huaweicloud.com/blogs/279731)